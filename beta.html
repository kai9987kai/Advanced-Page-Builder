<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ultimate Advanced Page Builder â€“ Full Features & Innovations</title>
  <style>
    /* Global Resets & Base Styles */
    * { box-sizing: border-box; }
    body, html {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      user-select: none;
      overflow: hidden;
    }
    /* Theme Switcher (Light/Dark) */
    body.theme-dark {
      background: #333;
      color: #ddd;
    }
    body.theme-dark .sidebar,
    body.theme-dark .main,
    body.theme-dark #workspace-container {
      background: #444;
      color: #ddd;
    }
    body.theme-dark button {
      background-color: #555;
      color: #ddd;
    }
    /* Layout: Sidebar and Main Workspace */
    .container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }
    .sidebar {
      width: 320px;
      background: #fff;
      border-right: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
      transition: background 0.3s ease;
    }
    .main {
      flex: 1;
      position: relative;
      overflow: hidden;
      background: #eaeaea;
    }
    /* Sidebar Section Styles */
    .section {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }
    .section:last-child { border-bottom: none; }
    .section h3 {
      margin: 0 0 5px;
      font-size: 16px;
      color: inherit;
    }
    .section .tools, .section .props {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .section input[type="text"],
    .section input[type="number"],
    .section input[type="color"],
    .section select,
    .section textarea {
      padding: 6px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      flex: 1;
    }
    button {
      padding: 8px 12px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s ease;
    }
    button:hover { background-color: #0056b3; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    label { font-size: 14px; margin-right: 6px; }
    /* Workspace Container */
    #workspace-container {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      margin: 10px;
      border: 2px dashed #aaa;
      background: #fafafa;
      overflow: auto;
      transform-origin: top left;
      border-radius: 4px;
    }
    #workspace {
      position: relative;
      width: 2400px;
      height: 2400px;
      background: #fafafa;
    }
    .grid-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 2400px;
      height: 2400px;
      pointer-events: none;
      background-size: 20px 20px;
      background-image:
        linear-gradient(to right, rgba(0,0,0,0.05) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0,0,0,0.05) 1px, transparent 1px);
    }
    .marquee {
      position: absolute;
      border: 1px dashed #007bff;
      background: rgba(0,123,255,0.15);
      pointer-events: none;
      z-index: 1000;
      display: none;
    }
    /* Draggable Element Wrapper & Handles */
    .draggable-wrapper {
      position: absolute;
      display: inline-block;
      transform-origin: center center;
      transition: all 0.1s ease;
    }
    .selected { outline: 2px solid #007bff; }
    .resize-handle {
      width: 10px;
      height: 10px;
      background: #007bff;
      position: absolute;
      border-radius: 50%;
      z-index: 10;
    }
    .resize-handle.tl { top: -5px; left: -5px; cursor: nw-resize; }
    .resize-handle.tr { top: -5px; right: -5px; cursor: ne-resize; }
    .resize-handle.bl { bottom: -5px; left: -5px; cursor: sw-resize; }
    .resize-handle.br { bottom: -5px; right: -5px; cursor: se-resize; }
    .rotate-handle {
      width: 12px;
      height: 12px;
      background: #ff5722;
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      border-radius: 50%;
      cursor: grab;
      z-index: 10;
    }
    /* Sticky Properties Panel */
    .prop-panel {
      border: 1px solid #ddd;
      background: #f9f9f9;
      padding: 8px;
      border-radius: 4px;
      margin-top: 10px;
      display: none;
      flex-direction: column;
      gap: 6px;
    }
    .prop-panel input,
    .prop-panel textarea,
    .prop-panel select {
      width: 100%;
      font-size: 14px;
    }
    /* Modal for Code Generation */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .modal-content {
      background: #fff;
      width: 80%;
      max-width: 800px;
      border-radius: 8px;
      padding: 20px;
      position: relative;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }
    .modal-content pre {
      max-height: 400px;
      overflow: auto;
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 13px;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      font-size: 18px;
      color: #888;
    }
    .modal-close:hover { color: #000; }
    .copy-button {
      margin-top: 10px;
      background: #28a745;
    }
  </style>
  <script>
    // Ensure the script runs after window load so that all elements are present.
    window.addEventListener('load', function() {
      /********************
       * GLOBAL VARIABLES *
       ********************/
      let selectedElements = [];
      const workspace = document.getElementById('workspace');
      const workspaceContainer = document.getElementById('workspace-container');
      const gridOverlay = document.getElementById('gridOverlay');
      const marquee = document.getElementById('marquee');
      const codeModal = document.getElementById('codeModal');
      const codeOutput = document.getElementById('codeOutput');
      const historySlider = document.getElementById('historySlider');
      let undoStack = [];
      let redoStack = [];
      let elementCounter = 0;
      const SNAP_SIZE = 20;
      let currentZoom = 1;
      let isMarqueeSelecting = false;
      let marqueeStart = { x: 0, y: 0 };
      let isDragging = false; // Prevents clearing selection while dragging

      /****************************
       * HELPER FUNCTIONS         *
       ****************************/
      // Converts an RGB(A) string to a hex color string.
      function rgbToHex(rgb) {
        if (!rgb) return '#ffffff';
        let result = /^rgba?\((\d+),\s*(\d+),\s*(\d+)/i.exec(rgb);
        return result ? "#" +
          ("0" + parseInt(result[1], 10).toString(16)).slice(-2) +
          ("0" + parseInt(result[2], 10).toString(16)).slice(-2) +
          ("0" + parseInt(result[3], 10).toString(16)).slice(-2) : '#ffffff';
      }

      /****************************
       * STATE MANAGEMENT METHODS *
       ****************************/
      function pushState() {
        const state = workspace.innerHTML;
        undoStack.push(state);
        historySlider.max = undoStack.length - 1;
        historySlider.value = undoStack.length - 1;
        redoStack = [];
      }
      function undo() {
        if (undoStack.length > 1) {
          redoStack.push(undoStack.pop());
          workspace.innerHTML = undoStack[undoStack.length - 1];
          historySlider.max = undoStack.length - 1;
          historySlider.value = undoStack.length - 1;
          reattachEventListeners();
        }
      }
      function redo() {
        if (redoStack.length > 0) {
          undoStack.push(redoStack.pop());
          workspace.innerHTML = undoStack[undoStack.length - 1];
          historySlider.max = undoStack.length - 1;
          historySlider.value = undoStack.length - 1;
          reattachEventListeners();
        }
      }
      function jumpToState(val) {
        val = parseInt(val);
        if (val >= 0 && val < undoStack.length) {
          redoStack = undoStack.slice(val + 1);
          undoStack = undoStack.slice(0, val + 1);
          workspace.innerHTML = undoStack[undoStack.length - 1];
          historySlider.max = undoStack.length - 1;
          historySlider.value = undoStack.length - 1;
          reattachEventListeners();
        }
      }
      function saveLayout() {
        localStorage.setItem('ultimateBuilderLayout', workspace.innerHTML);
        alert("Layout saved!");
      }
      function loadLayout() {
        const saved = localStorage.getItem('ultimateBuilderLayout');
        if (saved) {
          pushState();
          workspace.innerHTML = saved;
          reattachEventListeners();
          alert("Layout loaded!");
        } else {
          alert("No layout saved.");
        }
      }
      function clearWorkspace() {
        if (confirm("Clear the entire workspace?")) {
          pushState();
          workspace.innerHTML = "";
        }
      }
      function clearHistory() {
        undoStack = [];
        redoStack = [];
        historySlider.max = 0;
        historySlider.value = 0;
        alert("History cleared.");
      }
      function resetLayout() {
        if (confirm("Reset the entire layout? This will clear all elements.")) {
          pushState();
          workspace.innerHTML = "";
          currentZoom = 1;
          updateZoom();
          clearHistory();
        }
      }
      setInterval(() => { saveLayout(); }, 30000);

      /**********************************
       * ELEMENT CREATION & WRAPPING    *
       **********************************/
      function wrapElement(el) {
        const wrapper = document.createElement('div');
        wrapper.className = 'draggable-wrapper';
        wrapper.style.left = '10px';
        wrapper.style.top = '10px';
        wrapper.style.width = el.offsetWidth ? el.offsetWidth + 'px' : 'auto';
        wrapper.style.height = el.offsetHeight ? el.offsetHeight + 'px' : 'auto';
        wrapper.style.position = 'absolute';
        wrapper.style.opacity = 1;
        wrapper.style.borderRadius = "0px";
        wrapper.style.boxShadow = "none";
        wrapper.setAttribute('data-rotate', '0');
        wrapper.id = 'draggable-' + (++elementCounter);
        // Ensure child elements can receive pointer events
        el.style.width = '100%';
        el.style.height = '100%';
        el.style.pointerEvents = 'auto';
        wrapper.appendChild(el);
        ['tl','tr','bl','br'].forEach(pos => {
          const handle = document.createElement('div');
          handle.className = 'resize-handle ' + pos;
          wrapper.appendChild(handle);
          addResizeListener(wrapper, handle, pos);
        });
        const rotateHandle = document.createElement('div');
        rotateHandle.className = 'rotate-handle';
        wrapper.appendChild(rotateHandle);
        addRotateListener(wrapper, rotateHandle);
        addDragListeners(wrapper);
        wrapper.addEventListener('mousedown', function(e) {
          e.stopPropagation();
          if (e.shiftKey || e.ctrlKey) { toggleSelection(wrapper); }
          else { clearSelection(); addToSelection(wrapper); }
        });
        return wrapper;
      }
      function addLabel() {
        const text = document.getElementById('labelText').value || 'New Label';
        const label = document.createElement('div');
        label.textContent = text;
        label.style.padding = '4px 8px';
        label.style.background = '#f0f0f0';
        label.style.border = '1px solid #ccc';
        pushState();
        const wrapper = wrapElement(label);
        workspace.appendChild(wrapper);
      }
      function addButton() {
        const text = document.getElementById('buttonText').value || 'Click Me';
        const button = document.createElement('button');
        button.textContent = text;
        pushState();
        const wrapper = wrapElement(button);
        workspace.appendChild(wrapper);
      }
      function addImage() {
        const url = document.getElementById('imageUrl').value || 'https://via.placeholder.com/150';
        const img = document.createElement('img');
        img.src = url;
        img.style.display = 'block';
        pushState();
        const wrapper = wrapElement(img);
        workspace.appendChild(wrapper);
      }
      function addDalleImage() {
        const prompt = document.getElementById('dallePrompt').value || 'A futuristic cityscape';
        const img = document.createElement('img');
        img.src = 'https://picsum.photos/seed/' + encodeURIComponent(prompt) + '/200/150';
        img.style.display = 'block';
        img.title = prompt;
        pushState();
        const wrapper = wrapElement(img);
        workspace.appendChild(wrapper);
      }
      function addTable() {
        const rows = parseInt(document.getElementById('tableRows').value) || 3;
        const cols = parseInt(document.getElementById('tableCols').value) || 3;
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.background = '#ffffff';
        for (let i = 0; i < rows; i++) {
          const tr = document.createElement('tr');
          for (let j = 0; j < cols; j++) {
            const td = document.createElement('td');
            td.textContent = `R${i+1}C${j+1}`;
            td.style.border = '1px solid #ccc';
            td.style.padding = '4px';
            tr.appendChild(td);
          }
          table.appendChild(tr);
        }
        pushState();
        const wrapper = wrapElement(table);
        workspace.appendChild(wrapper);
      }
      function addList() {
        const itemsCount = parseInt(document.getElementById('listItems').value) || 5;
        const ul = document.createElement('ul');
        ul.style.listStyleType = 'disc';
        ul.style.paddingLeft = '20px';
        for (let i = 0; i < itemsCount; i++) {
          const li = document.createElement('li');
          li.textContent = `Item ${i+1}`;
          ul.appendChild(li);
        }
        pushState();
        const wrapper = wrapElement(ul);
        workspace.appendChild(wrapper);
      }

      /******************************************
       * DRAGGING, RESIZING, ROTATION FUNCTIONS *
       ******************************************/
      function addDragListeners(wrapper) {
        wrapper.style.cursor = 'move';
        wrapper.onmousedown = function(e) {
          if (e.target.classList.contains('resize-handle') || e.target.classList.contains('rotate-handle')) return;
          isDragging = true;
          e.preventDefault();
          let startX = e.clientX, startY = e.clientY;
          let origX = parseFloat(wrapper.style.left);
          let origY = parseFloat(wrapper.style.top);
          function onMouseMove(e) {
            let dx = e.clientX - startX;
            let dy = e.clientY - startY;
            let newLeft = origX + dx;
            let newTop = origY + dy;
            if (document.getElementById('snapToggle').checked) {
              newLeft = Math.round(newLeft / SNAP_SIZE) * SNAP_SIZE;
              newTop = Math.round(newTop / SNAP_SIZE) * SNAP_SIZE;
            }
            wrapper.style.left = newLeft + 'px';
            wrapper.style.top = newTop + 'px';
            if (selectedElements.includes(wrapper)) updatePropPanel(wrapper);
          }
          document.addEventListener('mousemove', onMouseMove);
          document.onmouseup = function() {
            document.removeEventListener('mousemove', onMouseMove);
            document.onmouseup = null;
            isDragging = false;
            pushState();
          };
        };
      }
      function addResizeListener(wrapper, handle, position) {
        handle.onmousedown = function(e) {
          e.stopPropagation();
          e.preventDefault();
          let startX = e.clientX, startY = e.clientY;
          let origWidth = wrapper.offsetWidth;
          let origHeight = wrapper.offsetHeight;
          let origLeft = parseFloat(wrapper.style.left);
          let origTop = parseFloat(wrapper.style.top);
          function onMouseMove(e) {
            let dx = e.clientX - startX;
            let dy = e.clientY - startY;
            if (position === 'br') {
              wrapper.style.width = (origWidth + dx) + 'px';
              wrapper.style.height = (origHeight + dy) + 'px';
            } else if (position === 'bl') {
              wrapper.style.width = (origWidth - dx) + 'px';
              wrapper.style.height = (origHeight + dy) + 'px';
              wrapper.style.left = (origLeft + dx) + 'px';
            } else if (position === 'tr') {
              wrapper.style.width = (origWidth + dx) + 'px';
              wrapper.style.height = (origHeight - dy) + 'px';
              wrapper.style.top = (origTop + dy) + 'px';
            } else if (position === 'tl') {
              wrapper.style.width = (origWidth - dx) + 'px';
              wrapper.style.height = (origHeight - dy) + 'px';
              wrapper.style.left = (origLeft + dx) + 'px';
              wrapper.style.top = (origTop + dy) + 'px';
            }
            if (document.getElementById('snapToggle').checked) {
              wrapper.style.width = Math.round(parseFloat(wrapper.style.width) / SNAP_SIZE) * SNAP_SIZE + 'px';
              wrapper.style.height = Math.round(parseFloat(wrapper.style.height) / SNAP_SIZE) * SNAP_SIZE + 'px';
              wrapper.style.left = Math.round(parseFloat(wrapper.style.left) / SNAP_SIZE) * SNAP_SIZE + 'px';
              wrapper.style.top = Math.round(parseFloat(wrapper.style.top) / SNAP_SIZE) * SNAP_SIZE + 'px';
            }
            if (selectedElements.includes(wrapper)) updatePropPanel(wrapper);
          }
          document.addEventListener('mousemove', onMouseMove);
          document.onmouseup = function() {
            document.removeEventListener('mousemove', onMouseMove);
            document.onmouseup = null;
            pushState();
          };
        };
      }
      function addRotateListener(wrapper, rotateHandle) {
        rotateHandle.onmousedown = function(e) {
          e.stopPropagation();
          e.preventDefault();
          let rect = wrapper.getBoundingClientRect();
          let centerX = rect.left + rect.width / 2;
          let centerY = rect.top + rect.height / 2;
          let startAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
          let origRotate = parseFloat(wrapper.getAttribute('data-rotate')) || 0;
          function onMouseMove(e) {
            let currentAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
            let diff = currentAngle - startAngle;
            let newAngle = origRotate + diff * (180 / Math.PI);
            wrapper.style.transform = 'rotate(' + newAngle + 'deg)';
            wrapper.setAttribute('data-rotate', newAngle);
            if (selectedElements.includes(wrapper)) updatePropPanel(wrapper);
          }
          document.addEventListener('mousemove', onMouseMove);
          document.onmouseup = function() {
            document.removeEventListener('mousemove', onMouseMove);
            document.onmouseup = null;
            pushState();
          };
        };
      }

      /*****************************************
       * SELECTION, MARQUEE & PROPERTIES PANEL *
       *****************************************/
      function addToSelection(el) {
        if (!selectedElements.includes(el)) {
          selectedElements.push(el);
          el.classList.add('selected');
        }
        updatePropPanel(el);
      }
      function removeFromSelection(el) {
        selectedElements = selectedElements.filter(item => item !== el);
        el.classList.remove('selected');
      }
      function toggleSelection(el) {
        if (selectedElements.includes(el)) removeFromSelection(el);
        else addToSelection(el);
      }
      function clearSelection() {
        // Only clear selection if not currently dragging
        if (!isDragging) {
          selectedElements.forEach(el => el.classList.remove('selected'));
          selectedElements = [];
          document.getElementById('propPanel').style.display = 'none';
        }
      }
      workspaceContainer.addEventListener('mousedown', function(e) {
        if (e.target === workspaceContainer || e.target === workspace) {
          if (!isDragging) clearSelection();
          isMarqueeSelecting = true;
          marqueeStart = { x: e.pageX, y: e.pageY };
          marquee.style.left = e.pageX + 'px';
          marquee.style.top = e.pageY + 'px';
          marquee.style.width = '0px';
          marquee.style.height = '0px';
          marquee.style.display = 'block';
        }
      });
      document.addEventListener('mousemove', function(e) {
        if (isMarqueeSelecting) {
          const x = Math.min(e.pageX, marqueeStart.x);
          const y = Math.min(e.pageY, marqueeStart.y);
          const w = Math.abs(e.pageX - marqueeStart.x);
          const h = Math.abs(e.pageY - marqueeStart.y);
          marquee.style.left = x + 'px';
          marquee.style.top = y + 'px';
          marquee.style.width = w + 'px';
          marquee.style.height = h + 'px';
        }
      });
      document.addEventListener('mouseup', function(e) {
        if (isMarqueeSelecting) {
          isMarqueeSelecting = false;
          marquee.style.display = 'none';
          const rect = marquee.getBoundingClientRect();
          document.querySelectorAll('.draggable-wrapper').forEach(el => {
            const elRect = el.getBoundingClientRect();
            if (!(elRect.right < rect.left || elRect.left > rect.right ||
                  elRect.bottom < rect.top || elRect.top > rect.bottom)) {
              addToSelection(el);
            }
          });
        }
      });
      function updatePropPanel(el) {
        if (selectedElements.length === 1) {
          const panel = document.getElementById('propPanel');
          panel.style.display = 'flex';
          document.getElementById('propLeft').value = parseFloat(el.style.left);
          document.getElementById('propTop').value = parseFloat(el.style.top);
          document.getElementById('propWidth').value = parseFloat(el.style.width);
          document.getElementById('propHeight').value = parseFloat(el.style.height);
          document.getElementById('propRotation').value = parseFloat(el.getAttribute('data-rotate')) || 0;
          document.getElementById('propOpacity').value = parseFloat(el.style.opacity);
          document.getElementById('propBorderRadius').value = parseFloat(el.style.borderRadius) || 0;
          document.getElementById('propBoxShadow').value = el.style.boxShadow || "";
          document.getElementById('propBgColor').value = rgbToHex(el.firstElementChild?.style.backgroundColor || '#ffffff');
          document.getElementById('propBorderColor').value = rgbToHex(el.firstElementChild?.style.borderColor || '#cccccc');
        } else {
          document.getElementById('propPanel').style.display = 'none';
        }
      }
      function updateProperties() {
        if (selectedElements.length === 1) {
          pushState();
          let el = selectedElements[0];
          el.style.left = document.getElementById('propLeft').value + 'px';
          el.style.top = document.getElementById('propTop').value + 'px';
          el.style.width = document.getElementById('propWidth').value + 'px';
          el.style.height = document.getElementById('propHeight').value + 'px';
          let newRot = document.getElementById('propRotation').value;
          el.style.transform = 'rotate(' + newRot + 'deg)';
          el.setAttribute('data-rotate', newRot);
          el.style.opacity = document.getElementById('propOpacity').value;
          el.style.borderRadius = document.getElementById('propBorderRadius').value + 'px';
          el.style.boxShadow = document.getElementById('propBoxShadow').value;
          if (el.firstElementChild) {
            el.firstElementChild.style.backgroundColor = document.getElementById('propBgColor').value;
            el.firstElementChild.style.borderColor = document.getElementById('propBorderColor').value;
          }
          pushState();
        }
      }

      /***********************************
       * GROUPING & UNGROUPING FUNCTIONS *
       ***********************************/
      function groupSelected() {
        if (selectedElements.length < 2) {
          alert("Select at least two elements to group.");
          return;
        }
        pushState();
        const group = document.createElement('div');
        group.className = 'draggable-wrapper';
        group.style.position = 'absolute';
        group.style.left = Math.min(...selectedElements.map(el => parseFloat(el.style.left))) + 'px';
        group.style.top = Math.min(...selectedElements.map(el => parseFloat(el.style.top))) + 'px';
        group.style.width = 'auto';
        group.style.height = 'auto';
        group.setAttribute('data-group', 'true');
        group.id = 'group-' + (++elementCounter);
        selectedElements.forEach(el => {
          let elLeft = parseFloat(el.style.left);
          let elTop = parseFloat(el.style.top);
          el.style.left = (elLeft - parseFloat(group.style.left)) + 'px';
          el.style.top = (elTop - parseFloat(group.style.top)) + 'px';
          group.appendChild(el);
        });
        workspace.appendChild(group);
        clearSelection();
        addToSelection(group);
        addDragListeners(group);
        reattachEventListeners();
        pushState();
      }
      function ungroupSelected() {
        if (selectedElements.length !== 1 || !selectedElements[0].getAttribute('data-group')) {
          alert("Select a grouped element to ungroup.");
          return;
        }
        pushState();
        const group = selectedElements[0];
        Array.from(group.children).forEach(child => {
          let groupLeft = parseFloat(group.style.left);
          let groupTop = parseFloat(group.style.top);
          child.style.left = (parseFloat(child.style.left) + groupLeft) + 'px';
          child.style.top = (parseFloat(child.style.top) + groupTop) + 'px';
          workspace.appendChild(child);
          addDragListeners(child);
        });
        group.remove();
        clearSelection();
        pushState();
      }

      /***************************************
       * ALIGNMENT & DISTRIBUTION FUNCTIONS  *
       ***************************************/
      function alignSelected(direction) {
        if (selectedElements.length < 2) {
          alert("Select multiple elements for alignment.");
          return;
        }
        pushState();
        const positions = selectedElements.map(el => ({
          left: parseFloat(el.style.left),
          top: parseFloat(el.style.top),
          width: parseFloat(el.style.width),
          height: parseFloat(el.style.height)
        }));
        if (direction === 'left') {
          const minLeft = Math.min(...positions.map(p => p.left));
          selectedElements.forEach(el => el.style.left = minLeft + 'px');
        } else if (direction === 'center') {
          const centers = positions.map(p => p.left + p.width / 2);
          const avgCenter = centers.reduce((a, b) => a + b, 0) / centers.length;
          selectedElements.forEach((el, i) => {
            el.style.left = (avgCenter - positions[i].width / 2) + 'px';
          });
        } else if (direction === 'right') {
          const maxRight = Math.max(...positions.map(p => p.left + p.width));
          selectedElements.forEach(el => {
            let p = positions[selectedElements.indexOf(el)];
            el.style.left = (maxRight - p.width) + 'px';
          });
        } else if (direction === 'top') {
          const minTop = Math.min(...positions.map(p => p.top));
          selectedElements.forEach(el => el.style.top = minTop + 'px');
        } else if (direction === 'middle') {
          const middles = positions.map(p => p.top + p.height / 2);
          const avgMiddle = middles.reduce((a, b) => a + b, 0) / middles.length;
          selectedElements.forEach((el, i) => {
            el.style.top = (avgMiddle - positions[i].height / 2) + 'px';
          });
        } else if (direction === 'bottom') {
          const maxBottom = Math.max(...positions.map(p => p.top + p.height));
          selectedElements.forEach(el => {
            let p = positions[selectedElements.indexOf(el)];
            el.style.top = (maxBottom - p.height) + 'px';
          });
        }
        pushState();
      }
      function distributeSelected(orientation) {
        if (selectedElements.length < 3) {
          alert("Select at least three elements to distribute.");
          return;
        }
        pushState();
        let sorted = [...selectedElements].sort((a, b) => {
          return orientation === 'horizontal'
            ? parseFloat(a.style.left) - parseFloat(b.style.left)
            : parseFloat(a.style.top) - parseFloat(b.style.top);
        });
        if (orientation === 'horizontal') {
          const first = parseFloat(sorted[0].style.left);
          const last = parseFloat(sorted[sorted.length - 1].style.left);
          const gap = (last - first) / (sorted.length - 1);
          sorted.forEach((el, i) => {
            el.style.left = (first + i * gap) + 'px';
          });
        } else {
          const first = parseFloat(sorted[0].style.top);
          const last = parseFloat(sorted[sorted.length - 1].style.top);
          const gap = (last - first) / (sorted.length - 1);
          sorted.forEach((el, i) => {
            el.style.top = (first + i * gap) + 'px';
          });
        }
        pushState();
      }

      /****************************
       * ZOOM & GRID FUNCTIONALITY *
       ****************************/
      function zoomIn() {
        currentZoom += 0.1;
        updateZoom();
      }
      function zoomOut() {
        currentZoom = Math.max(0.1, currentZoom - 0.1);
        updateZoom();
      }
      function resetZoom() {
        currentZoom = 1;
        updateZoom();
      }
      function updateZoom() {
        workspaceContainer.style.transform = 'scale(' + currentZoom + ')';
        document.getElementById('zoomValue').textContent = Math.round(currentZoom * 100) + '%';
      }
      function toggleGrid() {
        gridOverlay.style.display = (gridOverlay.style.display === 'none' || gridOverlay.style.display === '') ? 'block' : 'none';
      }
      function updateWorkspaceBg() {
        const mode = document.getElementById('bgMode').value;
        if (mode === 'color') {
          document.getElementById('bgColorTools').style.display = 'flex';
          document.getElementById('bgImageTools').style.display = 'none';
          workspace.style.background = document.getElementById('bgColor').value;
        } else if (mode === 'image') {
          document.getElementById('bgColorTools').style.display = 'none';
          document.getElementById('bgImageTools').style.display = 'flex';
          const url = document.getElementById('bgUrl').value;
          workspace.style.background = url ? "url('" + url + "') center/cover no-repeat" : "#fafafa";
        }
      }

      /***************************************
       * CODE GENERATION & DOWNLOAD          *
       ***************************************/
      function generateCode() {
        const elements = workspace.querySelectorAll('.draggable-wrapper');
        let globalCSS = document.getElementById('globalStyleTag')?.innerText || '';
        let htmlCode = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Generated Page</title>
  <style>
    body, html { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f0f2f5; }
    .draggable { position: absolute; }
    ${globalCSS}
  </style>
</head>
<body>
`;
        elements.forEach(wrapper => {
          const child = wrapper.firstElementChild;
          const styleStr = 'position:absolute;left:' + wrapper.style.left +
                           ';top:' + wrapper.style.top +
                           ';width:' + wrapper.style.width +
                           ';height:' + wrapper.style.height +
                           ';transform:' + wrapper.style.transform +
                           ';opacity:' + wrapper.style.opacity +
                           ';border-radius:' + wrapper.style.borderRadius +
                           ';box-shadow:' + wrapper.style.boxShadow + ';';
          htmlCode += `<div class="draggable" style="${styleStr}">
  ${child.outerHTML}
</div>\n`;
        });
        htmlCode += `</body>\n</html>`;
        console.log("Generated HTML Code:", htmlCode);
        codeOutput.innerText = htmlCode;
        openModal();
        return htmlCode;
      }
      function downloadCode() {
        const code = generateCode();
        const blob = new Blob([code], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'generated_page.html';
        a.click();
        URL.revokeObjectURL(url);
      }
      function openModal() { codeModal.style.display = 'flex'; }
      function closeModal() { codeModal.style.display = 'none'; }
      function copyCode() {
        navigator.clipboard.writeText(codeOutput.innerText).then(() => {
          alert("Code copied to clipboard!");
        });
      }

      /***************************************
       * GLOBAL CSS & JSON IMPORT/EXPORT     *
       ***************************************/
      function applyGlobalCSS() {
        let css = document.getElementById('globalCSS').value;
        let styleTag = document.getElementById('globalStyleTag');
        if (!styleTag) {
          styleTag = document.createElement('style');
          styleTag.id = 'globalStyleTag';
          document.head.appendChild(styleTag);
        }
        styleTag.innerText = css;
        alert("Global CSS applied!");
      }
      function importJSONPrompt() {
        let jsonStr = prompt("Paste your JSON layout here:");
        if (jsonStr) {
          try {
            let layout = JSON.parse(jsonStr);
            pushState();
            workspace.innerHTML = "";
            layout.forEach(item => {
              let temp = document.createElement('div');
              temp.innerHTML = item.content;
              let wrapper = wrapElement(temp.firstElementChild);
              wrapper.style.left = item.left;
              wrapper.style.top = item.top;
              wrapper.style.width = item.width;
              wrapper.style.height = item.height;
              wrapper.style.transform = item.transform;
              wrapper.style.opacity = item.opacity;
              wrapper.style.borderRadius = item.borderRadius;
              wrapper.style.boxShadow = item.boxShadow;
              workspace.appendChild(wrapper);
            });
            reattachEventListeners();
            alert("Layout imported!");
          } catch (e) {
            alert("Error parsing JSON: " + e.message);
          }
        }
      }
      function exportJSON() {
        const layout = [];
        document.querySelectorAll('.draggable-wrapper').forEach(wrapper => {
          layout.push({
            id: wrapper.id,
            left: wrapper.style.left,
            top: wrapper.style.top,
            width: wrapper.style.width,
            height: wrapper.style.height,
            transform: wrapper.style.transform,
            opacity: wrapper.style.opacity,
            borderRadius: wrapper.style.borderRadius,
            boxShadow: wrapper.style.boxShadow,
            content: wrapper.firstElementChild.outerHTML
          });
        });
        const jsonStr = JSON.stringify(layout, null, 2);
        alert("Exported JSON:\n" + jsonStr);
      }

      /***************************************
       * DUPLICATE, ROTATE, RESET & LOCK      *
       ***************************************/
      function duplicateSelected() {
        if (selectedElements.length === 0) {
          alert("Select an element to duplicate.");
          return;
        }
        pushState();
        selectedElements.forEach(el => {
          const clone = el.cloneNode(true);
          clone.id = 'draggable-' + (++elementCounter);
          clone.style.left = (parseFloat(el.style.left) + 20) + 'px';
          clone.style.top = (parseFloat(el.style.top) + 20) + 'px';
          workspace.appendChild(clone);
        });
        reattachEventListeners();
      }
      function rotateSelected(angle) {
        if (selectedElements.length !== 1) {
          alert("Select a single element to rotate.");
          return;
        }
        pushState();
        let el = selectedElements[0];
        let currentAngle = parseFloat(el.getAttribute('data-rotate')) || 0;
        let newAngle = currentAngle + angle;
        el.style.transform = 'rotate(' + newAngle + 'deg)';
        el.setAttribute('data-rotate', newAngle);
        updatePropPanel(el);
        pushState();
      }
      function resetTransform() {
        if (selectedElements.length !== 1) {
          alert("Select a single element to reset transformations.");
          return;
        }
        pushState();
        let el = selectedElements[0];
        el.style.transform = 'rotate(0deg)';
        el.setAttribute('data-rotate', '0');
        updatePropPanel(el);
        pushState();
      }
      function toggleLock() {
        if (selectedElements.length !== 1) {
          alert("Select a single element to lock/unlock.");
          return;
        }
        pushState();
        let el = selectedElements[0];
        if (el.getAttribute('data-locked') === 'true') {
          el.removeAttribute('data-locked');
          el.style.pointerEvents = 'auto';
          alert("Element unlocked.");
        } else {
          el.setAttribute('data-locked', 'true');
          el.style.pointerEvents = 'none';
          alert("Element locked.");
        }
        pushState();
      }
      function bringForward() {
        selectedElements.forEach(el => {
          el.style.zIndex = parseInt(el.style.zIndex || 1) + 1;
        });
        pushState();
      }
      function sendBackward() {
        selectedElements.forEach(el => {
          el.style.zIndex = Math.max(0, parseInt(el.style.zIndex || 1) - 1);
        });
        pushState();
      }

      /***************************************
       * EVENT REATTACHMENT AFTER STATE CHANGE*
       ***************************************/
      function reattachEventListeners() {
        document.querySelectorAll('.draggable-wrapper').forEach(wrapper => {
          addDragListeners(wrapper);
          wrapper.querySelectorAll('.resize-handle').forEach(handle => {
            let pos = '';
            if (handle.classList.contains('tl')) pos = 'tl';
            if (handle.classList.contains('tr')) pos = 'tr';
            if (handle.classList.contains('bl')) pos = 'bl';
            if (handle.classList.contains('br')) pos = 'br';
            addResizeListener(wrapper, handle, pos);
          });
          const rotateHandle = wrapper.querySelector('.rotate-handle');
          if (rotateHandle) addRotateListener(wrapper, rotateHandle);
          wrapper.addEventListener('mousedown', function(e) {
            e.stopPropagation();
            if (e.shiftKey || e.ctrlKey) toggleSelection(wrapper);
            else { clearSelection(); addToSelection(wrapper); }
          });
        });
      }

      /***************************************
       * GLOBAL EVENT LISTENERS              *
       ***************************************/
      workspace.addEventListener('mousedown', function(e) {
        if (e.target === workspace) clearSelection();
      });
      document.body.addEventListener('click', function(e) {
        if (!e.target.closest('.draggable-wrapper') && !e.target.closest('#marquee') && !e.target.closest('.prop-panel'))
          clearSelection();
      });
      codeModal.addEventListener('click', function(e) {
        if (e.target === codeModal) closeModal();
      });
      document.getElementById('bgMode').addEventListener('change', updateWorkspaceBg);

      /***************************************
       * INITIALIZATION                     *
       ***************************************/
      pushState();
      updateZoom();
      historySlider.max = 0;
      historySlider.value = 0;
      console.log("Ultimate Advanced Page Builder loaded with all features and innovations.");

      // Expose functions globally for inline event handlers:
      window.addLabel = addLabel;
      window.addButton = addButton;
      window.addImage = addImage;
      window.addDalleImage = addDalleImage;
      window.addTable = addTable;
      window.addList = addList;
      window.deleteSelected = function() {
        selectedElements.forEach(el => el.remove());
        clearSelection();
        pushState();
      };
      window.clearSelection = clearSelection;
      window.clearWorkspace = clearWorkspace;
      window.saveLayout = saveLayout;
      window.loadLayout = loadLayout;
      window.undo = undo;
      window.redo = redo;
      window.duplicateSelected = duplicateSelected;
      window.rotateSelected = rotateSelected;
      window.resetTransform = resetTransform;
      window.toggleLock = toggleLock;
      window.bringForward = bringForward;
      window.sendBackward = sendBackward;
      window.groupSelected = groupSelected;
      window.ungroupSelected = ungroupSelected;
      window.alignSelected = alignSelected;
      window.distributeSelected = distributeSelected;
      window.zoomIn = zoomIn;
      window.zoomOut = zoomOut;
      window.resetZoom = resetZoom;
      window.toggleGrid = toggleGrid;
      window.updateWorkspaceBg = updateWorkspaceBg;
      window.jumpToState = jumpToState;
      window.applyGlobalCSS = applyGlobalCSS;
      window.importJSONPrompt = importJSONPrompt;
      window.exportJSON = exportJSON;
      window.generateCode = generateCode;
      window.closeModal = closeModal;
      window.copyCode = copyCode;
      window.downloadCode = downloadCode;
    });
  </script>
</head>
<body>
  <div class="container">
    <!-- Sidebar: Tools & Properties -->
    <div class="sidebar">
      <!-- Theme Switcher -->
      <div class="section">
        <h3>Theme</h3>
        <div class="tools">
          <button onclick="document.body.classList.remove('theme-dark')" title="Switch to Light Theme">Light</button>
          <button onclick="document.body.classList.add('theme-dark')" title="Switch to Dark Theme">Dark</button>
        </div>
      </div>
      <!-- Element Tools -->
      <div class="section">
        <h3>Elements</h3>
        <div class="tools">
          <input type="text" id="labelText" placeholder="Label Text" title="Enter label text">
          <button onclick="addLabel()" title="Add Label">Text</button>
        </div>
        <div class="tools">
          <input type="text" id="buttonText" placeholder="Button Text" title="Enter button text">
          <button onclick="addButton()" title="Add Button">Button</button>
        </div>
        <div class="tools">
          <input type="text" id="imageUrl" placeholder="Image URL" title="Enter image URL">
          <button onclick="addImage()" title="Add Image">Image</button>
        </div>
        <div class="tools">
          <input type="text" id="dallePrompt" placeholder="DALL-E Prompt" title="Enter prompt">
          <button onclick="addDalleImage()" title="Simulate DALL-E">DALL-E</button>
        </div>
        <div class="tools">
          <label>Rows:</label>
          <input type="number" id="tableRows" min="1" value="3">
          <label>Cols:</label>
          <input type="number" id="tableCols" min="1" value="3">
          <button onclick="addTable()" title="Add Table">Table</button>
        </div>
        <div class="tools">
          <label>List Items:</label>
          <input type="number" id="listItems" min="1" value="5">
          <button onclick="addList()" title="Add List">List</button>
        </div>
      </div>
      <!-- Action Tools -->
      <div class="section">
        <h3>Actions</h3>
        <div class="tools">
          <button onclick="generateCode()" title="Preview Code">Gen Code</button>
          <button onclick="downloadCode()" title="Download Code">Download</button>
          <button onclick="deleteSelected()" title="Delete Selected">Delete</button>
          <button onclick="clearSelection()" title="Deselect All">Deselect</button>
          <button onclick="clearWorkspace()" title="Clear Workspace">Clear WS</button>
        </div>
        <div class="tools">
          <button onclick="saveLayout()" title="Save Layout">Save</button>
          <button onclick="loadLayout()" title="Load Layout">Load</button>
          <button onclick="undo()" title="Undo">Undo</button>
          <button onclick="redo()" title="Redo">Redo</button>
          <button onclick="duplicateSelected()" title="Duplicate Selected">Duplicate</button>
        </div>
        <div class="tools">
          <button onclick="rotateSelected(-15)" title="Rotate Left">Rotate L</button>
          <button onclick="rotateSelected(15)" title="Rotate Right">Rotate R</button>
          <button onclick="resetTransform()" title="Reset Transform">Reset Xf</button>
          <button onclick="toggleLock()" title="Lock/Unlock Selected">Lock/Unlock</button>
        </div>
        <div class="tools">
          <label>History:</label>
          <input type="range" id="historySlider" min="0" max="0" value="0" onchange="jumpToState(this.value)">
        </div>
      </div>
      <!-- Alignment & Grouping Tools -->
      <div class="section">
        <h3>Alignment & Grouping</h3>
        <div class="tools">
          <button onclick="bringForward()" title="Bring Forward">Bring +</button>
          <button onclick="sendBackward()" title="Send Backward">Send -</button>
          <button onclick="groupSelected()" title="Group Selected">Group</button>
          <button onclick="ungroupSelected()" title="Ungroup Selected">Ungroup</button>
        </div>
        <div class="tools">
          <button onclick="alignSelected('left')" title="Align Left">A Left</button>
          <button onclick="alignSelected('center')" title="Align Center">A Center</button>
          <button onclick="alignSelected('right')" title="Align Right">A Right</button>
        </div>
        <div class="tools">
          <button onclick="alignSelected('top')" title="Align Top">A Top</button>
          <button onclick="alignSelected('middle')" title="Align Middle">A Middle</button>
          <button onclick="alignSelected('bottom')" title="Align Bottom">A Bottom</button>
        </div>
        <div class="tools">
          <button onclick="distributeSelected('horizontal')" title="Distribute Horizontally">Dist H</button>
          <button onclick="distributeSelected('vertical')" title="Distribute Vertically">Dist V</button>
        </div>
      </div>
      <!-- Zoom & Grid -->
      <div class="section">
        <h3>Zoom & Grid</h3>
        <div class="tools">
          <button onclick="zoomIn()" title="Zoom In">Zoom In</button>
          <button onclick="zoomOut()" title="Zoom Out">Zoom Out</button>
          <button onclick="resetZoom()" title="Reset Zoom">Reset</button>
          <span id="zoomValue">100%</span>
        </div>
        <div class="tools">
          <label><input type="checkbox" id="snapToggle" checked> Snap Grid</label>
          <button onclick="toggleGrid()" title="Toggle Grid Overlay">Grid Toggle</button>
        </div>
      </div>
      <!-- Workspace Settings -->
      <div class="section">
        <h3>Workspace Settings</h3>
        <div class="tools">
          <label>Background Mode:</label>
          <select id="bgMode" onchange="updateWorkspaceBg()">
            <option value="color" selected>Color</option>
            <option value="image">Image</option>
          </select>
        </div>
        <div class="tools" id="bgColorTools">
          <label>BG Color:</label>
          <input type="color" id="bgColor" value="#fafafa">
        </div>
        <div class="tools" id="bgImageTools" style="display:none;">
          <label>BG Image URL:</label>
          <input type="text" id="bgUrl" placeholder="Enter image URL">
        </div>
      </div>
      <!-- Global CSS, JSON Import/Export & Theme Switcher -->
      <div class="section">
        <h3>Extras</h3>
        <div class="tools">
          <textarea id="globalCSS" rows="2" placeholder="Enter Global CSS"></textarea>
          <button onclick="applyGlobalCSS()" title="Apply Global CSS">Apply CSS</button>
        </div>
        <div class="tools">
          <button onclick="importJSONPrompt()" title="Import JSON Layout">Import JSON</button>
          <button onclick="exportJSON()" title="Export Layout as JSON">Export JSON</button>
        </div>
        <div class="tools">
          <button onclick="document.body.classList.remove('theme-dark')" title="Light Theme">Light Theme</button>
          <button onclick="document.body.classList.add('theme-dark')" title="Dark Theme">Dark Theme</button>
        </div>
      </div>
      <!-- Sticky Properties Panel -->
      <div class="section">
        <h3>Properties</h3>
        <div class="prop-panel" id="propPanel">
          <div>
            <label>Left:</label>
            <input type="number" id="propLeft" step="1">
          </div>
          <div>
            <label>Top:</label>
            <input type="number" id="propTop" step="1">
          </div>
          <div>
            <label>Width:</label>
            <input type="number" id="propWidth" step="1">
          </div>
          <div>
            <label>Height:</label>
            <input type="number" id="propHeight" step="1">
          </div>
          <div>
            <label>Rotation:</label>
            <input type="number" id="propRotation" step="1">
          </div>
          <div>
            <label>Opacity:</label>
            <input type="number" id="propOpacity" step="0.1" min="0" max="1">
          </div>
          <div>
            <label>Border Radius:</label>
            <input type="number" id="propBorderRadius" step="1">
          </div>
          <div>
            <label>Box Shadow:</label>
            <input type="text" id="propBoxShadow" placeholder="e.g., 2px 2px 5px #333">
          </div>
          <div>
            <label>BG Color:</label>
            <input type="color" id="propBgColor">
          </div>
          <div>
            <label>Border Color:</label>
            <input type="color" id="propBorderColor">
          </div>
          <div>
            <button onclick="updateProperties()" title="Apply Properties">Apply</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Main Workspace -->
    <div class="main">
      <div id="workspace-container">
        <div id="workspace">
          <div class="grid-overlay" id="gridOverlay" style="display:none;"></div>
        </div>
        <div id="marquee" class="marquee"></div>
      </div>
    </div>
  </div>
  <!-- Code Generation Modal -->
  <div id="codeModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <h3>Generated Code</h3>
      <pre id="codeOutput"></pre>
      <button class="copy-button" onclick="copyCode()">Copy Code</button>
    </div>
  </div>
</body>
</html>
